using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.IO;
using System.Globalization;

namespace QuanLySinhVien
{
    internal class Program
 {
     static string[,] sinhViens = new string[100, 8]; // Mảng lưu danh sách sinh viên (tối đa 100 sinh viên)
     static int sinhVienCount = 0; // Số lượng sinh viên hiện tại
     static string fileName = "SinhVien.txt"; // Đường dẫn đến file
 static void Main(string[] args)
     {
         while (true)
         {
             ShowMenu();
             Console.Write("\nChọn một tùy chọn (1-6): ");
             string choice = Console.ReadLine();

             switch (choice)
             {
                 {
                        case "1":
                            ThemSinhVien();
                            break;

                        case "2":
                            XoaSinhVien();
                            break;

                        case "3":
                            SuaSinhVien();
                            break;

                        case "4":
                            XemSinhVien();
                            break;

                        case "5":
                            XuatDanhSachHocBong();
                            break;

                        case "6":
                            XepLoaiTotNghiep();
                            break;

                        case "7":
                            Console.Clear();
                            Console.WriteLine("Chúc bạn học tốt!");
                            Environment.Exit(0);
                            break;

                        default:
                            Console.WriteLine("Lựa chọn không hợp lệ, vui lòng thử lại!");
                            break;
                    }
             }

             Console.WriteLine("\nNhấn phím bất kỳ để quay lại menu...");
             Console.ReadKey();
         }
     }

     static void ShowMenu()
     {
         Console.Clear();
         Console.WriteLine("===============================================");
         Console.WriteLine("            QUẢN LÝ SINH VIÊN UEH");
         Console.WriteLine("===============================================");
         Console.WriteLine("1. Thêm Sinh Viên");
         Console.WriteLine("2. Xem Danh Sách Sinh Viên");
         Console.WriteLine("3. Sửa Thông Tin Sinh Viên");
         Console.WriteLine("4. Xóa Sinh Viên");
         Console.WriteLine("5. Xuất Danh Sách Học Bổng");
         Console.WriteLine("6. Xếp Loại Tốt Nghiệp");
         Console.WriteLine("7. Thoát Chương Trình");
         Console.WriteLine("===============================================");
     }


 /// <summary>
 /// Đọc file SinhVien.txt
 /// </summary>
 static void DocFileSinhVien()
 {
     try
     {
         // Mở file SinhVien.txt và đọc dữ liệu
         using (StreamReader sr = new StreamReader("SinhVien.txt"))
         {
             string line;
             while ((line = sr.ReadLine()) != null)
             {
                 // Tách các trường từ dòng dữ liệu
                 string[] fields = line.Split(',');

                 if (fields.Length == 8)
                 {
                     sinhViens[sinhVienCount, 0] = fields[0];  // MSSV
                     sinhViens[sinhVienCount, 1] = fields[1];  // Lớp
                     sinhViens[sinhVienCount, 2] = fields[2];  // Họ Tên
                     sinhViens[sinhVienCount, 3] = fields[3];  // Ngày Sinh
                     sinhViens[sinhVienCount, 4] = fields[4];  // Nơi Sinh
                     sinhViens[sinhVienCount, 5] = fields[5];  // Giới Tính
                     sinhViens[sinhVienCount, 6] = fields[6];  // Điểm Trung Bình
                     sinhViens[sinhVienCount, 7] = fields[7];  // Điểm Rèn Luyện

                     sinhVienCount++;
                 }
             }
         }
     }
     catch (Exception ex)
     {
         Console.WriteLine("Lỗi khi đọc file SinhVien.txt: " + ex.Message);
     }
 }


 // Kiểm tra xem MSSV đã tồn tại trong file chưa
 static bool MSSVExist(string mssv)
 {
     try
     {
         // Đọc tất cả các dòng từ file
         string[] lines = File.ReadAllLines(fileName);

         foreach (string line in lines)
         {
             string[] data = line.Split(',');
             if (data[0] == mssv) // Kiểm tra MSSV đã tồn tại trong file
             {
                 return true; // MSSV đã tồn tại
             }
         }
     }
     catch (IOException ex)
     {
         Console.WriteLine($"Đã có lỗi khi đọc file: {ex.Message}");
     }
     return false; // MSSV không tồn tại
 }

 static void ThemSinhVien()
 {
     if (sinhVienCount >= sinhViens.GetLength(0))
     {
         Console.WriteLine("Danh sách sinh viên đã đầy!");
         return;
     }

     Console.WriteLine("=== Thêm Sinh Viên ===");

     // Nhập MSSV
     string mssv;
     while (true)
     {
         try
         {
             Console.Write("MSSV (8 số): ");
             mssv = Console.ReadLine();

             // Kiểm tra xem MSSV đã tồn tại trong file chưa
             if (MSSVExist(mssv))
             {
                 Console.WriteLine("Dữ liệu sinh viên đã tồn tại. Vui lòng nhập MSSV khác.");
                 continue;
             }

             if (mssv.Length != 8 || !mssv.All(char.IsDigit))
             {
                 throw new Exception("MSSV phải có 8 số. Vui lòng nhập lại.");
             }
             break;
         }
         catch (Exception ex)
         {
             Console.WriteLine(ex.Message);
         }
     }
     sinhViens[sinhVienCount, 0] = mssv;

     // Nhập Lớp
     string lop;
     while (true)
     {
         Console.Write("Lớp (Ví dụ: EEP001): ");
         lop = Console.ReadLine();
         if (lop.Length == 6 && lop.Substring(0, 3).All(char.IsLetter) && lop.Substring(3, 3).All(char.IsDigit))
         {
             break;
         }
         else
         {
             Console.WriteLine("Lớp phải có định dạng '3 chữ cái + 3 số'. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 1] = lop;

     // Nhập Họ Tên
     string hoTen;
     while (true)
     {
         Console.Write("Họ Tên: ");
         hoTen = Console.ReadLine();
         if (!string.IsNullOrWhiteSpace(hoTen))
         {
             break;
         }
         else
         {
             Console.WriteLine("Họ tên không thể để trống. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 2] = hoTen;

     // Nhập Ngày Sinh
     string ngaySinh;
     while (true)
     {
         Console.Write("Ngày Sinh (DD/MM/YYYY): ");
         ngaySinh = Console.ReadLine();
         if (DateTime.TryParseExact(ngaySinh, "dd/MM/yyyy", null, System.Globalization.DateTimeStyles.None, out _))
         {
             break;
         }
         else
         {
             Console.WriteLine("Ngày sinh không hợp lệ. Vui lòng nhập lại theo định dạng DD/MM/YYYY.");
         }
     }
     sinhViens[sinhVienCount, 3] = ngaySinh;

     // Nhập Nơi Sinh
     string noiSinh;
     while (true)
     {
         Console.Write("Nơi Sinh: ");
         noiSinh = Console.ReadLine();
         if (!string.IsNullOrWhiteSpace(noiSinh))
         {
             break;
         }
         else
         {
             Console.WriteLine("Nơi sinh không thể để trống. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 4] = noiSinh;

     // Nhập Giới Tính
     string gioiTinh;
     while (true)
     {
         Console.Write("Giới Tính (Nam/Nữ): ");
         gioiTinh = Console.ReadLine();
         if (gioiTinh.ToLower() == "nam" || gioiTinh.ToLower() == "nữ")
         {
             break;
         }
         else
         {
             Console.WriteLine("Giới tính phải là 'Nam' hoặc 'Nữ'. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 5] = gioiTinh;

     // Nhập Điểm Trung Bình
     double dtb;
     while (true)
     {
         Console.Write("Điểm Trung Bình (ĐTB, từ 1 đến 10): ");
         string dtbInput = Console.ReadLine();
         if (double.TryParse(dtbInput, out dtb) && dtb >= 1 && dtb <= 10)
         {
             break;
         }
         else
         {
             Console.WriteLine("Điểm Trung Bình phải từ 1 đến 10. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 6] = dtb.ToString();

     // Nhập Điểm Rèn Luyện
     int drl;
     while (true)
     {
         Console.Write("Điểm Rèn Luyện (ĐRL, từ 50 đến 100): ");
         string drlInput = Console.ReadLine();
         if (int.TryParse(drlInput, out drl) && drl >= 50 && drl <= 100)
         {
             break;
         }
         else
         {
             Console.WriteLine("Điểm Rèn Luyện phải từ 50 đến 100. Vui lòng nhập lại.");
         }
     }
     sinhViens[sinhVienCount, 7] = drl.ToString();

     sinhVienCount++;
     Console.WriteLine("Thêm sinh viên thành công!");

     // Cập nhật vào file SinhVien.txt
     GhiFileSinhVien();
 }


 static void GhiFileSinhVien()
 {
     try
     {
         using (StreamWriter sw = new StreamWriter(fileName))
         {
             for (int i = 0; i < sinhVienCount; i++)
             {
                 sw.WriteLine($"{sinhViens[i, 0]},{sinhViens[i, 1]},{sinhViens[i, 2]},{sinhViens[i, 3]},{sinhViens[i, 4]},{sinhViens[i, 5]},{sinhViens[i, 6]},{sinhViens[i, 7]}");
             }
         }
     }
     catch (Exception ex)
     {
         Console.WriteLine("Lỗi khi ghi file SinhVien.txt: " + ex.Message);
     }
 }

        static void XemDanhSachSinhVien()
        {
            Console.WriteLine("=== Danh Sách Sinh Viên ===");
            if (sinhVienCount == 0)
            {
                Console.WriteLine("Danh sách sinh viên trống!");
                return;
            }

            for (int i = 0; i < sinhVienCount; i++)
            {
                //Đổi điểm hệ 10 sang hệ 4
                double Diemtb = Double.Parse(sinhViens[i, 6]);
                double DiemHe4 = XetDiemCot4(Diemtb);
                //In ra thông tin sinh viên
                Console.WriteLine($"MSSV: {sinhViens[i, 0]} | Lớp: {sinhViens[i, 1]} | Họ Tên: {sinhViens[i, 2]} | " +
                                  $"Ngày Sinh: {sinhViens[i, 3]} | Nơi Sinh: {sinhViens[i, 4]} | Giới Tính: {sinhViens[i, 5]} | " +
                                  $"DTB: {sinhViens[i, 6]} | DRL: {sinhViens[i, 7]}");
            }
        }

       static void SuaSinhVien()
        {
            int index = -1;
            while (true)
            {
                try
                {
                    //Nhập MSSV. Kiếm tra cấu trúc của MSSV phải gồm 8 chữ số
                    Console.Write("Nhập MSSV của sinh viên cần sửa: ");
                    string mssv = Console.ReadLine();
                    long StudentID = long.Parse(mssv);
                    if (mssv.Length != 8)
                    {
                        throw new ArgumentException("Mã số sinh viên phải bao gồm đúng 8 chữ số.");
                    }
                    else
                    {
                        index = TimSinhVien(mssv);
                        break;
                    }
                }
                catch (FormatException)
                {
                    Console.WriteLine("Mã số sinh viên phải là số nguyên");
                }

            }
            //Tìm sinh viên dựa trên mã số, nếu không có thì thông báo
            if (index == -1)
            {
                Console.WriteLine("Không tìm thấy sinh viên với MSSV này.");
                return;
            }
            else
            {
                Console.WriteLine("=== Sửa Thông Tin Sinh Viên ===");
                while (true)
                {
                    try
                    {
                        //Nhập từng thông tin để sửa, nếu thông tin nào có định dạng đặc biệt thì cần kiểm tra
                        Console.Write("Lớp: ");
                        string lop = Console.ReadLine();

                        // Kiểm tra định dạng bằng Regular Expression
                        if (!System.Text.RegularExpressions.Regex.IsMatch(lop, @"^[a-zA-Z]{3}\d{3}$"))
                        {
                            throw new ArgumentException("Mã lớp không đúng định dạng. Vui lòng nhập lại.");
                        }
                        else
                        {
                            //Nếu nhập đúng thì cập nhật thông tin
                            sinhViens[index, 1] = lop;
                            break;
                        }

                    }
                    catch (ArgumentException ex)
                    {
                        Console.WriteLine($"Lỗi: {ex.Message}");
                    }
                    Console.WriteLine("Vui lòng thử lại.");
                }
            }
            //Nhập họ tên sinh viên
            Console.Write("Họ Tên: ");
            sinhViens[index, 2] = Console.ReadLine();
            //Nhập ngày sinh
            Console.Write("Ngày Sinh: ");
            DateTime NgaySinh;
            while (true)
            {
                try
                {
                    //Kiểm tra định dạng ngày sinh
                    string date = Console.ReadLine();
                    NgaySinh = DateTime.ParseExact(date, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                    sinhViens[index, 3] = date;
                    break; // Thoát khỏi vòng lặp nếu hợp lệ
                }
                catch (FormatException)
                {
                    Console.WriteLine("Ngày sinh không đúng định dạng. Vui lòng nhập lại (dd/MM/yyyy): ");
                }
            }
            //Nhập nơi sinh
            Console.Write("Nơi Sinh: ");
            sinhViens[index, 4] = Console.ReadLine();
            //Nhập giới tính
            Console.Write("Giới Tính: ");
            sinhViens[index, 5] = Console.ReadLine();
            //Nhập điểm trung bình
            Console.Write("Điểm Trung Bình (DTB): ");
            while (true)
            {
                try
                {
                    //Kiểm tra điểm trung bình phải là số dương và nhỏ hơn 10
                    string dtb = Console.ReadLine();
                    double Dtb = double.Parse(dtb);
                    if (Dtb >10 | Dtb < 0)
                    {
                        Console.WriteLine("Điểm trung bình không hợp lệ.");
                    }
                    else
                    {
                        //Cập nhật điểm nếu đúng cú pháp
                        sinhViens[index, 6] = dtb;
                        break;
                    }
                }
                catch (FormatException)
                {
                    //Báo sai định dạng điểm
                    Console.WriteLine("Điểm trung bình không đúng định dạng. Phải là số");
                }
            }
            
            //Nhập điểm trung bình
            Console.Write("Điểm Rèn Luyện (DRL): ");
            while (true)
            {
                try
                {
                    //Kiểm tra điểm trung bình phải là số dương và nhỏ hơn 100
                    string drl = Console.ReadLine();
                    int Drl = int.Parse(drl);
                    if (Drl > 100 | Drl < 0)
                    {
                        //Báo nếu nhập sai
                        Console.WriteLine("Điểm trung bình không hợp lệ.");
                    }
                    else
                    {
                        //Cập nhật điểm
                        sinhViens[index, 7] = drl;
                        break;
                    }
                }
                catch (FormatException)
                {
                    //Nếu điểm nhập vào không phải là số nguyên, chương trình sẽ thông báo
                    Console.WriteLine("Điểm trung bình không đúng định dạng. Phải là số");
                }
            }

            Console.WriteLine("Sửa thông tin thành công!");
        }

        static void XoaSinhVien()
        {
            int index = -1;
            while (true)
            {
                try
                {
                    //Nhập MSSV. Kiếm tra cấu trúc của MSSV phải gồm 8 chữ số
                    Console.Write("Nhập MSSV của sinh viên cần sửa: ");
                    string mssv = Console.ReadLine();
                    long StudentID = long.Parse(mssv);
                    if (mssv.Length != 8)
                    {
                        throw new ArgumentException("Mã số sinh viên phải bao gồm đúng 8 chữ số.");
                    }
                    else
                    {
                        index = TimSinhVien(mssv);
                        break;
                    }
                }
                catch (FormatException)
                {
                    Console.WriteLine("Mã số sinh viên phải là số nguyên");
                }

            }
            //Tìm sinh viên dựa trên mã số, nếu không có thì thông báo
            if (index == -1)
            {
                Console.WriteLine("Không tìm thấy sinh viên với MSSV này.");
                return;
            }
            else
            {
                // Dịch các phần tử phía sau lên một hàng
                for (int i = index; i < sinhVienCount - 1; i++)
                {
                    for (int j = 0; j < 8; j++)
                    {
                        sinhViens[i, j] = sinhViens[i + 1, j];
                    }
                }
                //Xóa hàng cuối cùng, bây giờ là hàng có thông tin của sinh viên cần xóa
                sinhVienCount--;
                Console.WriteLine("Xóa sinh viên thành công!");
            }
        }

        static void XuatDanhSachHocBong()
        {
            Console.WriteLine("=== Danh Sách Sinh Viên Xét Học Bổng ===");
            for (int i = 0; i < sinhVienCount; i++)
            {
                double dtb = double.Parse(sinhViens[i, 6]);
                int drl = int.Parse(sinhViens[i, 7]);

                if (dtb >= 8.0 && drl >= 80)
                {
                    Console.WriteLine($"{sinhViens[i, 2]} - MSSV: {sinhViens[i, 0]} - ĐTB: {dtb} - DRL: {drl}");
                }
            }
        }

        static int TimSinhVien(string mssv)
        {
            for (int i = 0; i < sinhVienCount; i++)
            {
                //Tìm sinh viên dựa trên mã số sinh viên
                if (sinhViens[i, 0] == mssv)
                {
                    //Trả lại số hàng của sinh viên đó trong mảng
                    return i;
                }
            }

            return -1;
        }
 static void XetLoaiTotNghiep(string a)
        {
            //Khai báo các biến
            double DTB = double.Parse(a);
            string LoaiTotNghiep;
            //Đổi điểm trung bình của sinh viên sang hệ 4
            double Diem = XetDiemCot4(DTB);
            //Đánh giá hạng tốt nghiệp dựa trên điểm trung bình
            if (Diem == 4) 
            { 
                LoaiTotNghiep = "Xuất sắc";
                Console.WriteLine($"Với điểm trung bình hiện tại, loại tốt nghiệp tạm thời của bạn là {LoaiTotNghiep}! Hãy cố gắng học tập nhé!");
            }
            else if (Diem == 3.5) 
            { 
                LoaiTotNghiep = "Giỏi";
                Console.WriteLine($"Với điểm trung bình hiện tại, loại tốt nghiệp tạm thời của bạn là {LoaiTotNghiep}! Hãy cố gắng học tập nhé!");
            }
            else if (Diem ==3|  Diem == 2.5)
            { 
                LoaiTotNghiep = "Khá";
                Console.WriteLine($"Với điểm trung bình hiện tại, loại tốt nghiệp tạm thời của bạn là {LoaiTotNghiep}! Hãy cố gắng học tập nhé!");
            }
            else if (Diem == 2) 
            { 
                LoaiTotNghiep = "Trung bình";
                Console.WriteLine($"Với điểm trung bình hiện tại, loại tốt nghiệp tạm thời của bạn là {LoaiTotNghiep}! Hãy cố gắng học tập nhé!");
            }
            else
            {
                //Nếu sinh viên chưa đủ điều kiện thì báo
                Console.WriteLine("Bạn chưa đủ điều kiện tốt nghiệp.");
            }
        }
        static double XetDiemCot4(double b)
        {
            //Quy đổi điểm hệ 10 sang điểm hệ 4
            if (b >= 8.5)
            {
                b = 4;
            }
            else if (b >= 8 && b <= 8.4)
            {
                b = 3.5;
            }
            else if (b >= 7 && b <= 7.9)
            {
                b = 3;
            }
            else if (b >= 6.5 && b <= 6.9)
            {
                b = 2.5;
            }
            else if (b >= 5.5 && b <= 6.4)
            {
                b = 2;
            }
            else if (b >= 5.4 && b <= 5)
            {
                b = 1.5;
            }
            else if (b >= 4 && b <= 4.9)
            {
                b = 1;
            }
            else
            {
                b = 0;
            }
            return b;
        }
    }
}
